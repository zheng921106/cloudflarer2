# .github/workflows/r2-migrate.yml
name: Cloudflare R2 Bucket Migration (rclone)

on:
  workflow_dispatch:
    inputs:
      SRC_BUCKET:
        description: "A桶名称（来源桶名）"
        required: true
        type: string
      DST_BUCKET:
        description: "B桶名称（目标桶名）"
        required: true
        type: string
      MODE:
        description: "迁移模式：copy(仅新增/更新) 或 sync(镜像，会删除目标多余对象)"
        required: true
        default: "copy"
        type: choice
        options: ["copy", "sync"]
      TRANSFERS:
        description: "并发传输数 (--transfers)"
        required: true
        default: "32"
        type: string
      CHECKERS:
        description: "并发校验数 (--checkers)"
        required: true
        default: "64"
        type: string
      S3_CHUNK_SIZE:
        description: "S3分片大小 (--s3-chunk-size)"
        required: true
        default: "100M"
        type: string
      S3_UPLOAD_CUTOFF:
        description: "直传阈值 (--s3-upload-cutoff)"
        required: true
        default: "100M"
        type: string

jobs:
  migrate:
    name: Migrate A→B with rclone
    runs-on: ubuntu-latest
    timeout-minutes: 1440  # 最长 24h，可按需调整
    env:
      SRC_BUCKET: ${{ inputs.SRC_BUCKET }}
      DST_BUCKET: ${{ inputs.DST_BUCKET }}
      MODE: ${{ inputs.MODE }}
      TRANSFERS: ${{ inputs.TRANSFERS }}
      CHECKERS: ${{ inputs.CHECKERS }}
      S3_CHUNK_SIZE: ${{ inputs.S3_CHUNK_SIZE }}
      S3_UPLOAD_CUTOFF: ${{ inputs.S3_UPLOAD_CUTOFF }}
    steps:
      - name: Install rclone
        run: |
          curl -fsSL https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Prepare rclone config
        run: |
          mkdir -p ~/.config/rclone
          cat > ~/.config/rclone/rclone.conf <<EOF
          [r2src]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2PUSH_ACCESS_KEY}
          secret_access_key = ${R2PUSH_SECRET_KEY}
          endpoint = ${R2PUSH_ENDPOINT}
          acl = private
          no_check_bucket = true

          [r2dst]
          type = s3
          provider = Cloudflare
          access_key_id = ${R2DST_ACCESS_KEY}
          secret_access_key = ${R2DST_SECRET_KEY}
          endpoint = ${R2DST_ENDPOINT}
          acl = private
          no_check_bucket = true
          EOF
        env:
          R2PUSH_ACCESS_KEY: ${{ secrets.R2PUSH_ACCESS_KEY }}
          R2PUSH_SECRET_KEY: ${{ secrets.R2PUSH_SECRET_KEY }}
          R2PUSH_ENDPOINT: ${{ secrets.R2PUSH_ENDPOINT }}
          R2DST_ACCESS_KEY: ${{ secrets.R2DST_ACCESS_KEY }}
          R2DST_SECRET_KEY: ${{ secrets.R2DST_SECRET_KEY }}
          R2DST_ENDPOINT: ${{ secrets.R2DST_ENDPOINT }}

      - name: Sanity check (list first 20 objects)
        run: |
          echo "Listing source bucket: ${SRC_BUCKET}"
          rclone lsf r2src:"${SRC_BUCKET}" | head -n 20 || true
          echo "Listing destination bucket: ${DST_BUCKET}"
          rclone lsf r2dst:"${DST_BUCKET}" | head -n 20 || true

      - name: Run migration
        run: |
          COMMON_ARGS="-P --transfers=${TRANSFERS} --checkers=${CHECKERS} --fast-list \
          --s3-upload-cutoff=${S3_UPLOAD_CUTOFF} --s3-chunk-size=${S3_CHUNK_SIZE} --metadata"

          if [[ "${MODE}" == "sync" ]]; then
            rclone sync r2src:"${SRC_BUCKET}" r2dst:"${DST_BUCKET}" $COMMON_ARGS --delete-after
          else
            rclone copy r2src:"${SRC_BUCKET}" r2dst:"${DST_BUCKET}" $COMMON_ARGS
          fi

      - name: Compare sizes (post-check)
        run: |
          echo "Source size:"
          rclone size r2src:"${SRC_BUCKET}" || true
          echo "Destination size:"
          rclone size r2dst:"${DST_BUCKET}" || true

      - name: Emit summary
        if: always()
        run: |
          {
            echo "### R2 Migration Summary"
            echo "- Mode: \`${MODE}\`"
            echo "- Source bucket: \`${SRC_BUCKET}\`"
            echo "- Destination bucket: \`${DST_BUCKET}\`"
            echo "- Transfers: \`${TRANSFERS}\` | Checkers: \`${CHECKERS}\`"
            echo "- s3-chunk-size: \`${S3_CHUNK_SIZE}\` | s3-upload-cutoff: \`${S3_UPLOAD_CUTOFF}\`"
            echo ""
            echo "#### Sample listing"
            echo "\`\`\`"
            rclone lsf r2dst:"${DST_BUCKET}" | head -n 50 || true
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY
